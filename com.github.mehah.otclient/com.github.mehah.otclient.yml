app-id: com.github.mehah.otclient
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: otclient

finish-args:
  - --device=dri # OpenGL rendering
  - --filesystem=xdg-data/otclient:create
  - --share=ipc # share IPC namespace with the host (necessary for X11)
  - --share=network # access the network
  - --socket=pulseaudio # play sound with PulseAudio
  - --socket=x11 # show windows using X11

modules:
  - name: otclient
    buildsystem: cmake
    no-make-install: true
    post-install:
      - install -Dm755 -t ${FLATPAK_DEST}/bin /run/build/otclient/otclient
      - install -Dm644 -t ${FLATPAK_DEST}/share/otclient init.lua

    sources:
      - type: file
        path: Findasio.cmake
        dest: cmake

      - type: git
        url: https://github.com/mehah/otclient
        tag: main

      - type: patch
        path: patches/otclient-2.6.2-init-lua-xdg-data-home.patch

    modules:
      - name: asio
        install-rule: install-data
        config-opts:
          - --prefix=/app
          - --without-boost

        sources:
          - type: archive
            url: https://sourceforge.net/projects/asio/files/asio/1.26.0%20%28Stable%29/asio-1.26.0.tar.bz2
            sha256: 858320108a0dfc6504cc1b3403182de8ccda1fb8f1c8a4e980e4cb03a11db34d
            x-checker-data:
              type: anitya
              project-id: 117
              url-template: https://sourceforge.net/projects/asio/files/asio/$version%20%28Stable%29/asio-$version.tar.bz2

      - name: glew
        no-autogen: true
        make-args: &glew-make-args
          - GLEW_PREFIX=${FLATPAK_DEST}
          - GLEW_DEST=${FLATPAK_DEST}
          - LIBDIR=${FLATPAK_DEST}/lib
          - CFLAGS.EXTRA:=${CFLAGS} -fPIC
          - LDFLAGS.EXTRA=${LDFLAGS}
        make-install-args: *glew-make-args

        sources:
          - type: archive
            url: https://github.com/nigels-com/glew/releases/download/glew-2.2.0/glew-2.2.0.tgz
            sha256: d4fc82893cfb00109578d0a1a2337fb8ca335b3ceccf97b97e5cc7f08e4353e1
            x-checker-data:
              type: anitya
              project-id: 7878
              url-template: https://github.com/nigels-com/glew/releases/download/glew-$version/glew-$version.tgz

        cleanup:
          - /include
          - /lib/pkgconfig
          - /lib/*.a

        modules:
          - name: glu
            config-opts:
              - --disable-static

            sources:
              - type: archive
                url: https://mesa.freedesktop.org/archive/glu/glu-9.0.2.tar.xz
                sha256: 6e7280ff585c6a1d9dfcdf2fca489251634b3377bfc33c29e4002466a38d02d4
                x-checker-data:
                  type: anitya
                  project-id: 13518
                  url-template: https://mesa.freedesktop.org/archive/glu/glu-$version.tar.xz

            cleanup:
              - /include
              - /lib/*.a
              - /lib/*.la
              - /lib/pkgconfig

      - name: LuaJIT
        no-autogen: true
        make-args: &luajit-make-args
          - PREFIX=/app
        make-install-args: *luajit-make-args

        sources:
          - type: archive
            url: https://github.com/LuaJIT/LuaJIT/archive/refs/tags/v2.0.5.tar.gz
            sha256: 8bb29d84f06eb23c7ea4aa4794dbb248ede9fcb23b6989cbef81dc79352afc97
            x-checker-data:
              type: anitya
              project-id: 6444
              url-template: https://github.com/LuaJIT/LuaJIT/archive/refs/tags/v$version.tar.gz

        cleanup:
          - /bin
          - /include
          - /lib/pkgconfig
          - /share/man
          - '*.a'

      - name: nlohmann-json
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON
          - -DJSON_BuildTests=OFF

        sources:
          - type: archive
            url: https://github.com/nlohmann/json/archive/v3.11.2.tar.gz
            sha256: d69f9deb6a75e2580465c6c4c5111b89c4dc2fa94e3a85fcd2ffcd9a143d9273
            x-checker-data:
              type: anitya
              project-id: 11152
              url-template: https://github.com/nlohmann/json/archive/v$version.tar.gz

      - name: parallel-hashmap
        buildsystem: cmake-ninja
        config-opts:
          - -DPHMAP_BUILD_TESTS=OFF
          - -DPHMAP_BUILD_EXAMPLES=OFF

        sources:
          - type: archive
            url: https://github.com/greg7mdp/parallel-hashmap/archive/refs/tags/v1.3.8.tar.gz
            sha256: c4562ea360dc1dcaddd96a0494c753400364a52c7aa9750de49d8e6a222d28d3

      - name: PhysicsFS
        buildsystem: cmake-ninja
        config-opts:
          - -DPHYSFS_BUILD_TEST=off
          - -DPHYSFS_BUILD_STATIC=OFF

        sources:
          - type: archive
            url: https://icculus.org/physfs/downloads/physfs-3.0.2.tar.bz2
            sha256: 304df76206d633df5360e738b138c94e82ccf086e50ba84f456d3f8432f9f863
            size: 194888
            x-checker-data:
              type: anitya
              project-id: 3631
              url-template: https://icculus.org/physfs/downloads/physfs-$version.tar.bz2

      - name: protobuf
        buildsystem: cmake-ninja
        builddir: true
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DBUILD_SHARED_LIBS=ON
          - -Dprotobuf_BUILD_TESTS=OFF

        sources:
          - type: archive
            url: https://github.com/protocolbuffers/protobuf/releases/download/v21.12/protobuf-cpp-3.21.12.tar.gz
            sha256: 4eab9b524aa5913c6fffb20b2a8abf5ef7f95a80bc0701f3a6dbb4c607f73460
            x-checker-data:
              type: anitya
              project-id: 3715
              url-template: https://github.com/protocolbuffers/protobuf/releases/download/v$version/protobuf-cpp-3.$version.tar.gz

        cleanup:
          - /bin

      - name: stduuid
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DUUID_BUILD_TESTS=OFF
          - -DUUID_USING_CXX20_SPAN=ON

        sources:
          - type: archive
            url: https://github.com/mariusbancila/stduuid/archive/refs/tags/v1.2.3.tar.gz
            sha256: b1176597e789531c38481acbbed2a6894ad419aab0979c10410d59eb0ebf40d3

          - type: patch
            path: patches/stduuid-1.2.3-fix-include-dest.patch

      - name: vorbis
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DBUILD_SHARED_LIBS=ON
          - -DCMAKE_VERBOSE_MAKEFILE=ON

        sources:
          - type: archive
            url: https://github.com/xiph/vorbis/releases/download/v1.3.7/libvorbis-1.3.7.tar.xz
            sha256: b33cc4934322bcbf6efcbacf49e3ca01aadbea4114ec9589d1b1e9d20f72954b
            x-checker-data:
              type: anitya
              project-id: 1758
              url-template: https://github.com/xiph/vorbis/releases/download/v$version/libvorbis-$version.tar.xz

          - type: patch
            path: patches/libvorbis-1.3.7-aotuv-b6.03.patch

          - only-arches:
              - x86_64
            type: patch
            path: patches/libvorbis-1.3.7-aotuv-b6.03-lancer.patch

        cleanup:
          - /share/doc/libvorbis*
